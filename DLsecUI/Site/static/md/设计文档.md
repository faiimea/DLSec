# Screen-Sharing Tool设计文档



**521021910094 王晨侃**

[TOC]

##  1.功能设计概述

### 1.1 总体设计

该应用名为Screen-Sharing Tool，在windows下运行，主要实现了视频传输和实时聊天功能。该应用主要由两个部分组成，服务端和客户端。其中服务端使用基于FFmpeg的视频流传输，基于rtmp协议实现了视频流的广播、本地实现了回放录制与保存、基于socket的聊天服务器的建立；客户端实现了由SQL为数据库存储的用户控制（用户的登录与注册）、使用Nginx服务器+VLCplayer实现接受广播并播放视频、视频流的切换、基于socket的聊天室服务的参与。

### 1.2 模块设计

应用主要分为6个模块，分别为传输模块（Transmit Module），VLC模块（VLC module），聊天服务端（ChatServer Module），聊天客户端（ChatClient Module），权限控制与数据库（SQL Module），可视化模块（GUI Module），模块架构如下图所示。

![未命名文件(3)](F:\SJTU\2023-2\项目管理与项目设计\文档\未命名文件(3).jpg)

在第二节中我将详细介绍每个功能模块的设计与使用。

## 2. 功能模块详述

### 2.1 传输模块（Transmit Module）

传输模块属于服务端，是用来视频传输的解决方案，主要由两个子模块构成，一个是视频截图子模块，另一个是FFmpeg传输模块。

#### 2.1.1视频截图子模块

```python
 while True:
        image=ImageGrab.grab()
        frame=cv2.cvtColor(np.array(image), cv2.COLOR_RGB2BGR)
        p.stdin.write(frame.tobytes())
```

视频截图子模块的核心代码主要是使用Pillow库对屏幕实时截图，并使用CV2库和FFmpeg将视频截图改变颜色模式，转成字节流，然后通过FFmpeg传输模块进行传输。

#### 2.1.2 FFmpeg传输模块

FFmpeg使用管道对打包好的字节流进行广播，广播的地址、视频的大小和帧率可以由用户自己定义。

### 2.2 VLC模块（VLC Module）

VLC模块属于Client端，主要实现的功能有视频的播放、视频换流，暂未实现还在开发接口的有视频的暂停与恢复、视频的停止、视频时放资源、音频的同步传输。核心的类是Player，作为视频播放器，它使用Python-vlc库，并在GUI Module的canvas上进行播放。

```python
class Player:
    def __init__(self, *args)
    def set_uri(self, uri)
    def start_recording(self,path)
    def play(self, path=None)
    def pause(self)
    def resume(self)
    def stop(self)
    def release(self)
    def is_playing(self)
    def get_time(self)
    def set_time(self, ms)
    def get_length(self) 
    def get_volume(self)
    def set_volume(self, volume)
    def get_state(self)
    def get_position(self)
    def set_position(self, float_val)
    def get_rate(self)
    def set_rate(self, rate)
    def set_ratio(self, ratio)
    def set_window(self, wm_id)
    def add_callback(self, event_type, callback)
    def remove_callback(self, event_type, callback)
```

 VLC模块需要依赖Nginx服务器提供rtmp协议服务。我编写了screensharing.conf文件作为配置文件，核心配置如下所示：

```
rtmp {
    server {
        listen 1935;
        chunk_size 4000;
        application live {
            live on;
            allow publish 127.0.0.1;
            allow play all;
		}
    }
}
```



### 2.3 讨论模块（ChatServer Module & ChatClient Module）

讨论模块主要由两个子模块构成，聊天服务端和聊天客户端两个子模块。其中聊天服务端在Server端运行，聊天客户端主要在Client端运行。

#### 2.3.1 聊天服务端

聊天服务端主要有四个操作，分别是初始化、广播、处理和接收消息。其中：

- 初始化用于使用socket绑定端口和IP地址，为接收消息与广播操作做准备；
- 广播操作对每一个client发来的消息进行广播，以确保client收到消息并能够显示在GUI模块中；
- 处理模块中，Server会对每一个client的名称进行存储来维护clients队列，同时确保每一个client是否仍然在聊天室内；
- 接收消息的模块是聊天服务端的主线程，在这个模块中我使用了多线程使处理消息和接受并广播消息同时进行，防止阻塞和不同步。

核心类ChatServer具体定义如下所示：

```python
class ChatServer:
    def __init__(self,mainwindow=None, host='127.0.0.1', port=12345)
    def broadcast(self, message)
    def handle(self, client)
    def receive(self)
```

#### 2.3.2 聊天客户端

聊天客户端主要有四个操作，分别是初始化、接收消息、写消息与主线程操作。其中：

- 初始化使用socket绑定端口和IP地址，为接收消息和发送消息做准备；
- 接收消息对server发出的消息进行解码和接受；
- 写消息对server发出消息；
- 主线程同时进行写消息和读消息，防止两者阻塞与冲突；

核心类ChatClient的具体定义如下所示：

```python
class ChatClient:
    def __init__(self, mainwindow:None,nickname:str=None,host='127.0.0.1', port=12345)
    def receive(self)
    def write(self)
    def run(self)
```

### 2.4 权限控制与数据库模块（SQL Module）

权限控制与数据库模块为客户端提供了权限控制和数据库处理的接口，可用于验证客户登录的合法性，并且提供查询接口：

- `filter_input(max_length=100)`: 这个函数用于接收用户输入的字符串，并进行一些过滤操作，包括过滤中文字符、特殊字符和十六进制代码，防止SQL注入，并限制字符串的长度。

- `connect_db()`: 这个函数用于连接到MySQL数据库。

- `init_db()`: 这个函数用于初始化数据库，包括创建两个表：`Users`和`IP`。

- `login(account,password)`: 这个函数用于验证用户的账号和密码是否在`Users`表中。

- `register(account:str,password:str)`: 这个函数用于在`Users`表中注册新用户。

- `add_IP(account:str,ip:str,port:int)`: 这个函数用于在`IP`表中添加新的IP记录。

- `get_IP(account:str)`: 这个函数用于从`IP`表中获取指定用户的所有IP记录。

- `close_db(cnx)`: 这个函数用于关闭数据库连接。

### 2.5 可视化模块（GUI Module）

#### 2.5.1 模块设计

GUI模块使用Tkinter和Ttkbootstrap，主要包含两个窗口的类，一个用以存储用户身份的类和一些操作的函数：

1. `identity`类：这个类用于存储用户的账号和用户的身份（服务器或客户端）。
2. `login_window`类：这个类是一个Tkinter窗口，用于处理用户的登录和注册操作。它包含以下主要方法：
   - `__init__`：初始化窗口，设置窗口的标题、大小、样式等，并创建一些Tkinter组件，如标签、输入框和按钮。
   - `login`：处理用户的登录操作，包括验证用户的账号和密码，如果登录成功，就创建一个`identity`对象并打开主窗口。
   - `display_messagebox`：显示消息框，用于提示用户登录或注册的结果。
   - `register`：处理用户的注册操作，包括验证用户的账号和密码，如果注册成功，就在数据库中创建一个新的用户记录。
   - `confirm_server`：确认用户的身份，是服务器还是客户端。
3. `mainwindow`类，它是主窗口，包含以下主要方法：
   - `__init__`：初始化窗口，设置窗口的标题、大小等，并创建一些Tkinter组件，如菜单、按钮、文本框等。
   - `on_message_received`：处理接收到的消息，将消息添加到文本框中。
   - `send_message`：发送消息，获取输入框中的文本并发送。
   - `create_vlc`：创建一个VLC播放器，用于播放视频流。
   - `create_chat_window`：创建一个聊天窗口，包括一个文本框用于显示聊天记录，一个输入框用于输入消息，和一个按钮用于发送消息。
   - `quit_app`：退出应用程序。
   - `create_menu`：创建菜单，包括连接、退出和全屏等选项。
   - `set_IP`：设置IP地址。
   - `add_ip_window`：添加一个新的窗口，用于输入IP地址。
   - `login_exit`：退出登录，隐藏主窗口，并打开登录窗口。

#### 2.5.2 模块流程

具体流程见下：

![未命名文件](F:\SJTU\2023-2\项目管理与项目设计\文档\未命名文件.jpg)

可视化使用过程见演示与PPT。

## 3.依赖环境与运行平台

### 3.1 依赖环境

开发使用Python3.12.2，Anaconda管理环境。Requirements.txt见代码。

本应用额外使用Python-vlc Package，但因为无法直接引用，所以将代码库下载以后放到目录vlc-3.0.20，阅读代码时需注意。

本应用使用的Nginx服务器为Nginx 1.7.11.3 Gryphon，需要注意的是普通版本的Nginx并没有支持rtmp协议的rtmp模块，因此将服务器也放入了代码目录nginx 1.7.11.3 Gryphon中，使用时需注意。

### 3.2 运行平台

本应用可以在windows和linux下使用，暂时没有适配移动端。



